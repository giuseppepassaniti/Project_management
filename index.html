<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <h1 class="text-4xl font-bold text-center mb-2">Project Hub</h1>
    <p class="text-center text-slate-600 mb-6">Carica il file dei progetti e seleziona un progetto per iniziare.</p>

    <div class="flex justify-center mb-8">
      <input type="file" id="csvInput" accept=".csv" class="hidden" />
      <button onclick="document.getElementById('csvInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md text-sm">
        <span>ðŸ“¤ Carica CSV Progetti</span>
      </button>
    </div>

    <div id="projectList" class="space-y-4"></div>
  </div>

  <script>
    let projects = [];

    document.getElementById('csvInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          projects = results.data;
          localStorage.setItem("csv_data_progetti", JSON.stringify(projects));
          renderProjects(projects);
        }
      });
    });

    function renderProjects(data) {
      const container = document.getElementById('projectList');
      container.innerHTML = "";

      data.forEach(proj => {
        const card = document.createElement("div");
        card.className = "bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow";

        const title = document.createElement("h2");
        title.className = "text-xl font-bold mb-1";
        title.textContent = proj["Nome Progetto"] || "Senza Titolo";

        const subtitle = document.createElement("p");
        subtitle.className = "text-slate-600 mb-4";
        subtitle.textContent = `${proj["Cliente"] || ""} | PM: ${proj["PM responsabile"] || ""}`;

        const progressWrap = document.createElement("div");
        progressWrap.className = "mb-4";
        const perc = parseInt(proj["% Avanzamento"]) || 0;
        progressWrap.innerHTML = `
          <div class="flex justify-between text-sm mb-1">
            <span>Avanzamento</span><span class="font-semibold">${perc}%</span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-3">
            <div class="bg-blue-600 h-3 rounded-full" style="width: ${perc}%"></div>
          </div>
        `;

        const kpi = document.createElement("div");
        kpi.className = "grid grid-cols-3 text-center text-sm my-3";
        const budget = parseCurrency(proj["Budget Iniziale"]);
        const costi = parseCurrency(proj["Costi Sostenuti"]);
        const previsione = parseCurrency(proj["Previsione Finale Costi"]);
        kpi.innerHTML = `
          <div><p class="text-slate-500">Budget</p><p class="font-bold">${budget}</p></div>
          <div><p class="text-slate-500">Costi</p><p class="font-bold">${costi}</p></div>
          <div><p class="text-slate-500">Previsione</p><p class="font-bold">${previsione}</p></div>
        `;

        const nav = document.createElement("div");
        nav.className = "grid grid-cols-3 gap-2 mt-4 text-xs font-semibold";
        const id = proj["Id Progetto"];
        const links = [
          { name: "Milestone", file: "Milestone.html" },
          { name: "Task", file: "Task.html" },
          { name: "Imprevisti", file: "Imprevisti.html" },
          { name: "Varianti", file: "Varianti.html" },
          { name: "Decisioni", file: "Decisionlog.html" },
        ];

        links.forEach(link => {
          const btn = document.createElement("a");
          btn.href = `${link.file}?id=${id}`;
          btn.target = "_blank";
          btn.className = "bg-white border border-slate-300 text-slate-700 text-center px-3 py-2 rounded hover:bg-slate-50";
          btn.textContent = link.name;
          nav.appendChild(btn);
        });

        card.append(title, subtitle, progressWrap, kpi, nav);
        container.appendChild(card);
      });
    }

    function parseCurrency(str) {
      if (!str || typeof str !== 'string') return "0 â‚¬";
      const num = parseFloat(str.replace(/[.â‚¬\s]/g, '').replace(',', '.')) || 0;
      return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(num);
    }

    // Ricarica dati da localStorage se presenti
    const cached = localStorage.getItem("csv_data_progetti");
    if (cached) {
      projects = JSON.parse(cached);
      renderProjects(projects);
    }
  </script>
</body>
</html>
