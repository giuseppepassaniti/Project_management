<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Hub Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PapaParse per il parsing CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Day.js per la manipolazione delle date + Locale Italiano -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/it.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .kpi-card { transition: transform 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-4px); }
        .project-list-item { transition: background-color 0.2s, border-left-color 0.2s; }
        .project-list-item:hover { background-color: #f8fafc; border-left-color: #3b82f6; }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="text-slate-800">

    <!-- Contenitore Principale -->
    <div class="container mx-auto p-4 md:p-6">
        
        <!-- Vista Selezione Progetto (Visibile all'inizio) -->
        <div id="project-selection-view">
            <header class="mb-6 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Project Hub</h1>
                <p class="text-slate-600 mt-1">Carica il file dei progetti e seleziona un progetto per iniziare.</p>
            </header>
            <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
                <label for="main-csv-input" class="w-full inline-block text-center cursor-pointer bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                    <i data-lucide="upload" class="inline-block h-5 w-5 mr-2"></i>Carica CSV Progetti
                </label>
                <input type="file" id="main-csv-input" class="hidden" accept=".csv">
            </div>
            <div id="project-list-container" class="mt-8 max-w-3xl mx-auto hidden">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Seleziona un Progetto</h2>
                <div id="project-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Vista Dashboard Dettaglio Progetto (Nascosta all'inizio) -->
        <div id="project-dashboard-view" class="hidden">
            <button id="back-to-projects-btn" class="mb-4 flex items-center text-sm text-blue-600 hover:underline">
                <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>Torna alla lista progetti
            </button>

            <!-- Header Progetto -->
            <header id="project-details-header" class="bg-white p-6 rounded-lg shadow-md mb-6"></header>

            <!-- Navigazione Sezioni Operative -->
            <nav class="mb-6">
                <div id="dashboard-tabs" class="border-b border-slate-200 flex space-x-6">
                    <!-- I tab verranno inseriti qui da JS -->
                </div>
            </nav>

            <!-- Contenuto Sezione -->
            <main id="section-content">
                <!-- Il contenuto delle sotto-dashboard verrà renderizzato qui -->
            </main>
        </div>
    </div>

    <script>
        // Configura Day.js in italiano
        dayjs.locale('it');

        document.addEventListener('DOMContentLoaded', () => {
            // --- RIFERIMENTI DOM ---
            const mainCsvInput = document.getElementById('main-csv-input');
            const projectSelectionView = document.getElementById('project-selection-view');
            const projectDashboardView = document.getElementById('project-dashboard-view');
            const projectListContainer = document.getElementById('project-list-container');
            const projectList = document.getElementById('project-list');
            const backToProjectsBtn = document.getElementById('back-to-projects-btn');
            const projectDetailsHeader = document.getElementById('project-details-header');
            const dashboardTabs = document.getElementById('dashboard-tabs');
            const sectionContent = document.getElementById('section-content');

            // --- STATO APPLICAZIONE ---
            let allProjects = [];
            let selectedProject = null;
            // Dati per le sotto-dashboard (verranno popolati dai loro uploader)
            let subDashboardData = {
                milestones: [],
                tasks: [],
                imprevisti: [],
                varianti: [],
                decisioni: []
            };

            // --- FUNZIONI DI PARSING E UTILITY ---
            const parseCurrency = (str) => {
                if (typeof str !== 'string' || !str) return 0;
                return parseFloat(str.replace(/[.€\s]/g, '').replace(',', '.')) || 0;
            };
            const parsePercentage = (str) => {
                if (typeof str !== 'string' || !str) return 0;
                return parseInt(str.replace('%', ''), 10) || 0;
            };
            const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
            
            const statusInfo = {
                'In corso': { badge: 'bg-yellow-100 text-yellow-800' },
                'Completato': { badge: 'bg-green-100 text-green-800' },
                'Da approvare': { badge: 'bg-blue-100 text-blue-800' },
                'Default': { badge: 'bg-slate-100 text-slate-800' },
            };

            // --- LOGICA PRINCIPALE ---
            mainCsvInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        transform: (value) => value.trim(),
                        complete: (results) => processProjectsData(results.data),
                        error: (err) => alert(`Errore nel parsing del CSV: ${err.message}`),
                    });
                }
            });

            function processProjectsData(data) {
                allProjects = data.map(row => {
                    if (!row['Id Progetto'] || !row['Nome Progetto']) return null;
                    return {
                        id: row['Id Progetto'],
                        name: row['Nome Progetto'],
                        client: row.Cliente,
                        pm: row['PM responsabile'],
                        status: row.Stato,
                        budget: parseCurrency(row['Budget Iniziale']),
                        startDate: dayjs(row['Data Inizio'], 'DD/MM/YYYY').toDate(),
                        endDate: dayjs(row['Data Fine'], 'DD/MM/YYYY').toDate(),
                        progress: parsePercentage(row['% Avanzamento']),
                        costs: parseCurrency(row['Costi Sostenuti']),
                        forecast: parseCurrency(row['Previsione Finale Costi']),
                    };
                }).filter(Boolean);

                if (allProjects.length > 0) {
                    renderProjectSelection();
                } else {
                    alert('Nessun progetto valido trovato nel file.');
                }
            }

            function renderProjectSelection() {
                projectList.innerHTML = allProjects.map(p => `
                    <div class="project-list-item bg-white p-4 rounded-lg shadow-sm border-l-4 border-transparent cursor-pointer" data-id="${p.id}">
                        <h3 class="font-bold text-slate-800">${p.name}</h3>
                        <p class="text-sm text-slate-500">${p.client}</p>
                    </div>
                `).join('');
                projectListContainer.classList.remove('hidden');

                projectList.querySelectorAll('.project-list-item').forEach(item => {
                    item.addEventListener('click', () => selectProject(item.dataset.id));
                });
            }

            function selectProject(projectId) {
                selectedProject = allProjects.find(p => p.id === projectId);
                if (!selectedProject) return;

                projectSelectionView.classList.add('hidden');
                projectDashboardView.classList.remove('hidden');

                renderProjectHeader();
                renderTabs();
                // Mostra la prima sezione di default
                loadSection('milestone'); 
            }

            function renderProjectHeader() {
                const deviation = selectedProject.forecast - selectedProject.budget;
                const deviationColor = deviation > 0 ? 'text-red-600' : 'text-green-600';
                const stat = statusInfo[selectedProject.status] || statusInfo.Default;

                projectDetailsHeader.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900">${selectedProject.name}</h1>
                            <p class="text-slate-500">${selectedProject.client} | PM: ${selectedProject.pm}</p>
                        </div>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${stat.badge}">${selectedProject.status}</span>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Avanzamento</span>
                            <span class="font-semibold">${selectedProject.progress}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full" style="width: ${selectedProject.progress}%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="kpi-card bg-slate-50 p-4 rounded-lg"><p class="text-sm text-slate-500">Budget Iniziale</p><p class="text-xl font-bold">${formatCurrency(selectedProject.budget)}</p></div>
                        <div class="kpi-card bg-slate-50 p-4 rounded-lg"><p class="text-sm text-slate-500">Costi Sostenuti</p><p class="text-xl font-bold">${formatCurrency(selectedProject.costs)}</p></div>
                        <div class="kpi-card bg-slate-50 p-4 rounded-lg"><p class="text-sm text-slate-500">Previsione Finale</p><p class="text-xl font-bold">${formatCurrency(selectedProject.forecast)}</p></div>
                        <div class="kpi-card bg-slate-50 p-4 rounded-lg"><p class="text-sm text-slate-500">Scostamento</p><p class="text-xl font-bold ${deviationColor}">${formatCurrency(deviation)}</p></div>
                    </div>
                `;
            }

            function renderTabs() {
                const sections = [
                    { id: 'milestone', label: 'Milestone', icon: 'flag' },
                    { id: 'task', label: 'Task', icon: 'list-checks' },
                    { id: 'imprevisti', label: 'Imprevisti', icon: 'siren' },
                    { id: 'varianti', label: 'Varianti', icon: 'git-pull-request-draft' },
                    { id: 'decisioni', label: 'Decision Log', icon: 'gavel' }
                ];

                dashboardTabs.innerHTML = sections.map(s => `
                    <button id="tab-${s.id}" class="tab-button flex items-center py-3 px-1 border-b-2 border-transparent text-slate-500 hover:text-blue-600" data-section="${s.id}">
                        <i data-lucide="${s.icon}" class="h-4 w-4 mr-2"></i>${s.label}
                    </button>
                `).join('');

                dashboardTabs.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', () => loadSection(btn.dataset.section));
                });
            }

            function loadSection(sectionId) {
                // Aggiorna stile tab
                dashboardTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`tab-${sectionId}`).classList.add('active');

                // Mostra il contenuto della sezione
                sectionContent.innerHTML = getSectionHTML(sectionId);
                
                // Aggiungi event listener specifici e renderizza i dati se disponibili
                setupSection(sectionId);
                lucide.createIcons();
            }

            function getSectionHTML(sectionId) {
                // Questo template di base viene usato per ogni sezione
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div id="${sectionId}-uploader" class="text-center p-8 border-2 border-dashed rounded-lg">
                            <i data-lucide="file-up" class="h-10 w-10 mx-auto text-slate-400 mb-2"></i>
                            <h3 class="font-semibold">Dati ${sectionId} non caricati</h3>
                            <p class="text-sm text-slate-500 mb-4">Carica il file CSV per questa sezione.</p>
                            <label for="${sectionId}-csv-input" class="cursor-pointer bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 text-sm">
                                Carica CSV ${sectionId}
                            </label>
                            <input type="file" id="${sectionId}-csv-input" class="hidden" accept=".csv">
                        </div>
                        <div id="${sectionId}-content" class="hidden">
                            <!-- Contenuto specifico della sezione (es. card, tabelle) -->
                        </div>
                    </div>
                `;
            }

            function setupSection(sectionId) {
                const uploaderEl = document.getElementById(`${sectionId}-uploader`);
                const contentEl = document.getElementById(`${sectionId}-content`);
                const inputEl = document.getElementById(`${sectionId}-csv-input`);

                inputEl.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                // Salva i dati nella sezione corretta
                                subDashboardData[sectionId] = results.data;
                                // Renderizza la vista con i nuovi dati
                                renderSectionContent(sectionId, selectedProject.id);
                            }
                        });
                    }
                });
                
                // Se i dati per questa sezione sono già stati caricati, renderizzali
                if (subDashboardData[sectionId] && subDashboardData[sectionId].length > 0) {
                    renderSectionContent(sectionId, selectedProject.id);
                }
            }

            function renderSectionContent(sectionId, projectId) {
                const uploaderEl = document.getElementById(`${sectionId}-uploader`);
                const contentEl = document.getElementById(`${sectionId}-content`);
                
                uploaderEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

                // Filtra i dati per il progetto corrente
                const data = subDashboardData[sectionId].filter(item => item.Progetto === projectId);

                if (data.length === 0) {
                    contentEl.innerHTML = `<p class="text-center text-slate-500">Nessun dato trovato per "${sectionId}" per il progetto ${projectId}.</p>`;
                    return;
                }
                
                // Funzione di rendering specifica per ogni sezione
                // Per semplicità, qui mostriamo solo una tabella di base
                const headers = Object.keys(data[0]);
                contentEl.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 capitalize">${sectionId} per ${projectId}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>${headers.map(h => `<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                ${data.map(row => `
                                    <tr>${headers.map(h => `<td class="px-4 py-2 whitespace-nowrap text-sm">${row[h]}</td>`).join('')}</tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // --- Navigazione e Reset ---
            backToProjectsBtn.addEventListener('click', () => {
                projectDashboardView.classList.add('hidden');
                projectSelectionView.classList.remove('hidden');
                selectedProject = null;
            });

            // Inizializzazione icone
            lucide.createIcons();
        });
    </script>
</body>
</html>
